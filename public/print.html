<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>打印单据</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
  <style>
    body { font-family: 'Microsoft YaHei', '微软雅黑', sans-serif; background: #fff; }
    .print-wrapper { max-width: 1100px; margin: 0 auto; padding: 20px; }
    @media print { .print-wrapper { padding: 8px; max-width: 100%; } }
    .print-header { text-align: center; margin-bottom: 10px; }
    .print-header .company-name { font-size: 18pt; font-weight: bold; letter-spacing: 1px; color: #000; }
    .print-header .doc-title { font-size: 14pt; margin: 4px 0; }
    .meta-row { display: flex; gap: 0; border: 1px solid #333; border-bottom: none; }
    .meta-cell { flex: 1; padding: 4px 8px; border-right: 1px solid #333; font-size: 10pt; }
    .meta-cell:last-child { border-right: none; }
    .meta-label { color: #333; font-weight: bold; display: inline; }
    .meta-val { border-bottom: 1px solid #333; display: inline-block; min-width: 80px; margin-left: 4px; }
    .reason-row { border: 1px solid #333; border-bottom: none; padding: 4px 8px; font-size: 10pt; }
    .print-table { width: 100%; border-collapse: collapse; font-size: 9pt; margin-top: 0; }
    .print-table th, .print-table td { border: 1px solid #333; padding: 3px 5px; text-align: center; vertical-align: middle; }
    .print-table th { background: #e8e8e8; font-weight: bold; white-space: nowrap; }
    .print-table .notes-col { background: #ffff99; font-weight: bold; }
    .checkbox-row { display: flex; gap: 0; border: 1px solid #333; border-bottom: none; font-size: 9pt; }
    .checkbox-group { flex: 1; padding: 3px 8px; border-right: 1px solid #333; }
    .checkbox-group:last-child { border-right: none; }
    .checkbox-label { font-weight: bold; margin-right: 8px; }
    .cb-item { margin-right: 10px; display: inline-block; }
    .cb-box { display: inline-block; width: 12px; height: 12px; border: 1px solid #333; margin-right: 3px; vertical-align: middle; text-align: center; line-height: 12px; font-size: 9pt; }
    .checked { background: #000; color: #fff; }
    .print-controls { position: fixed; top: 10px; right: 10px; z-index: 999; }
    @media print { .print-controls { display: none; } }

    /* Slush-specific */
    .product-img { max-width: 60px; max-height: 60px; }
  </style>
</head>
<body>
  <div class="print-controls no-print">
    <button onclick="window.print()" class="btn btn-primary btn-sm me-2">
      <i class="bi bi-printer me-1"></i>打印
    </button>
    <button onclick="window.close()" class="btn btn-secondary btn-sm">关闭</button>
  </div>

  <div class="print-wrapper" id="printContent">
    <div class="text-center py-5 text-muted" id="loading">正在加载数据...</div>
  </div>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script>
    const params = new URLSearchParams(location.search);
    const type = params.get('type');
    const id   = params.get('id');

    const typeMap = { injection: '啤办单', slush: '搪胶单', spray: '喷油单' };

    fetch(`/api/${type}/${id}`)
      .then(r => r.json())
      .then(order => {
        document.title = `${typeMap[type]} - ${order.order_number || order.id}`;
        const el = document.getElementById('printContent');
        el.innerHTML = type === 'injection' ? renderInjection(order)
                     : type === 'slush'     ? renderSlush(order)
                     :                        renderSpray(order);
        setTimeout(() => window.print(), 600);
      })
      .catch(() => {
        document.getElementById('loading').textContent = '加载失败，请关闭后重试';
      });

    function ck(checked) {
      return `<span class="cb-box${checked ? ' checked' : ''}">${checked ? '√' : ''}</span>`;
    }
    function v(val) { return val || ''; }

    function renderInjection(o) {
      const items = o.items || [];
      const isHuaDeng = o.workshop === '华登车间';
      const companyName = isHuaDeng ? '东莞华登塑胶制品有限公司' : '东莞兴信塑胶制品有限公司';
      const logoSrc = isHuaDeng ? 'huadeng-logo.png' : 'xinxin-logo.png';
      const logoHtml = `<img src="${logoSrc}" style="height:54px;width:auto;object-fit:contain" onerror="this.style.display='none'">`;
      const stg = o.stage || '';
      const op  = o.order_type || '';
      // Check if stage and operation match
      const isCk = (s, t) => stg === s && (op === t || (t === '啤办' && op === '啤板'));

      // Pad to 20 rows
      const allRows = [...items];
      while (allRows.length < 20) allRows.push({});

      const rows = allRows.map((it, i) => `
        <tr style="height:22px">
          <td>${i + 1}</td>
          <td>${v(it.mold_id)}</td>
          <td>${v(it.mold_name)}</td>
          <td>${v(it.material)}</td>
          <td>${v(it.color)}</td>
          <td>${v(it.pigment_no||it.color_code)}</td>
          <td>${v(it.quantity)}</td>
          <td>${v(it.shoot_qty||it.color_weight_g)}</td>
          <td>${v(it.gross_weight_g||it.total_weight_kg)}</td>
          <td>${v(it.required_material_kg)}</td>
          <td>${v(it.mold_return_time||it.mold_fee_time)}</td>
          <td>${v(it.completion_time)}</td>
        </tr>`).join('');

      return `
        <div class="print-header" style="margin-bottom:6px">
          <div style="display:flex;align-items:center;justify-content:center;gap:12px">
            ${logoHtml}
            <span class="company-name">${companyName}</span>
          </div>
        </div>
        <div class="meta-row">
          <div class="meta-cell"><span class="meta-label">TO:</span><span class="meta-val">${v(o.workshop)}</span></div>
          <div class="meta-cell"><span class="meta-label">产品编号：</span><span class="meta-val">${v(o.order_number)}</span></div>
          <div class="meta-cell"><span class="meta-label">订单编号：</span><span class="meta-val"></span></div>
          <div class="meta-cell"><span class="meta-label">日期：</span><span class="meta-val">${v(o.date)}</span></div>
        </div>
        <div class="checkbox-row">
          <div class="checkbox-group">
            <span class="checkbox-label">EP</span>
            <span class="cb-item">${ck(isCk('EP','试模'))}试模</span>
            <span class="cb-item">${ck(isCk('EP','试色'))}试色</span>
            <span class="cb-item">${ck(isCk('EP','啤办'))}啤办</span>
          </div>
          <div class="checkbox-group">
            <span class="checkbox-label">FEP</span>
            <span class="cb-item">${ck(isCk('FEP','试模'))}试模</span>
            <span class="cb-item">${ck(isCk('FEP','试色'))}试色</span>
            <span class="cb-item">${ck(isCk('FEP','啤办'))}啤办</span>
          </div>
          <div class="checkbox-group">
            <span class="checkbox-label">PP</span>
            <span class="cb-item">${ck(isCk('PP','试模'))}试模</span>
            <span class="cb-item">${ck(isCk('PP','试色'))}试色</span>
            <span class="cb-item">${ck(isCk('PP','啤办'))}啤办</span>
          </div>
          <div class="checkbox-group">
            <span class="checkbox-label">T0</span>
            <span class="cb-item">${ck(isCk('T0','试模'))}试模</span>
            <span class="cb-item">${ck(isCk('T0','试色'))}试色</span>
            <span class="cb-item">${ck(isCk('T0','啤办'))}啤办</span>
          </div>
        </div>
        <div class="reason-row"><strong>原因：</strong>${v(o.reason)}</div>
        <table class="print-table">
          <thead>
            <tr>
              <th style="width:28px">序号</th>
              <th>工模编号</th>
              <th>工模名称</th>
              <th>原料</th>
              <th>颜色</th>
              <th>色粉编号</th>
              <th>件数/<br>套数</th>
              <th>数量<br>(啤)</th>
              <th>整啤毛重<br>(g)</th>
              <th>所需用料<br>(KG)</th>
              <th>模具回厂<br>时间</th>
              <th>啤办完成<br>时间</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
        <div style="margin-top:0;font-size:8pt;border:1px solid #333;border-top:none;padding:5px 8px;line-height:1.7">
          <strong>备注：</strong><br>
          1.试模请写报告。<br>
          2.每套模镶10啤，不需剪水口，每啤分开装再装入一个大袋。<br>
          3.啤机必须洗干净，不能有遗留黑点和杂色，顶针位不能有油污。<br>
          4.胶件颜色必须对样样板或色牌，查调色啤办单注明颜色，需确知本人对色。<br>
          5.胶件要摆放整齐，避免胶件划花。<br>
          6.150吨及以下机型给3KG，150吨及以上机型给5KG。
        </div>
        <div style="margin-top:6px;font-size:9pt;border:1px solid #333;padding:5px 10px;display:flex;align-items:center;flex-wrap:wrap;gap:14px">
          <strong>分发：</strong>
          <span>${ck(false)} 经理室</span>
          <span>${ck(false)} 计务部</span>
          <span>${ck(false)} 啤机部</span>
          <span>${ck(false)} 啤油部</span>
          <span>${ck(false)} 装配部</span>
        </div>
        <div style="margin-top:10px;font-size:9pt;display:flex;padding:0 4px">
          <span style="flex:1"><strong>申请：</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
          <span style="flex:1;text-align:right"><strong>审核：</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
        </div>`;
    }

    function renderSlush(o) {
      const items = o.items || [];
      let rows = items.map(it => `
        <tr>
          <td>${v(it.seq_no)}</td>
          <td>${v(it.product_id)}</td>
          <td>${it.product_image ? `<img src="${it.product_image}" class="product-img">` : ''}</td>
          <td>${v(it.mold_id)}</td>
          <td>${v(it.mold_name)}</td>
          <td>${v(it.material)}</td>
          <td>${v(it.color_code)}</td>
          <td>${v(it.pigment_no)}</td>
          <td>${v(it.unit_weight)}</td>
          <td>${v(it.quantity)}</td>
          <td>${v(it.required_date)}</td>
          <td>${v(it.return_time)}</td>
          <td>${v(it.notes)}</td>
        </tr>`).join('');

      return `
        <div class="print-header">
          <div class="company-name">东莞兴信塑胶制品有限公司</div>
          <div class="doc-title">搪胶搪办通知书</div>
        </div>
        <div class="meta-row">
          <div class="meta-cell"><span class="meta-label">由：</span><span class="meta-val">工程部</span></div>
          <div class="meta-cell"><span class="meta-label">订单编号：</span><span class="meta-val">${v(o.order_number)}</span></div>
          <div class="meta-cell"><span class="meta-label">日期：</span><span class="meta-val">${v(o.date)}</span></div>
          <div class="meta-cell"><span class="meta-label">车间：</span><span class="meta-val">搪胶部</span></div>
        </div>
        <div class="checkbox-row">
          <div class="checkbox-group">
            <span class="checkbox-label">EP</span>
            <span class="cb-item">${ck(false)}试模</span>
            <span class="cb-item">${ck(false)}试色</span>
            <span class="cb-item">${ck(false)}啤板</span>
          </div>
          <div class="checkbox-group">
            <span class="checkbox-label">FEP</span>
            <span class="cb-item">${ck(false)}试模</span>
            <span class="cb-item">${ck(false)}试色</span>
            <span class="cb-item">${ck(false)}啤板</span>
          </div>
          <div class="checkbox-group">
            <span class="checkbox-label">PP</span>
            <span class="cb-item">${ck(false)}试模</span>
            <span class="cb-item">${ck(false)}试色</span>
            <span class="cb-item">${ck(o.order_type==='搪办')}啤板</span>
          </div>
          <div class="checkbox-group">
            <span class="checkbox-label">其他</span>
            <span class="cb-item">${ck(true)}新颜色啤办</span>
          </div>
        </div>
        <div class="reason-row"><strong>原因：</strong>${v(o.reason)}</div>
        <table class="print-table">
          <thead>
            <tr>
              <th>序号</th><th>产品编号</th><th>产品图片</th><th>工模编号</th><th>工模名称</th>
              <th>原料</th><th>颜色/编号</th><th>色粉编号</th><th>每啤毛重</th>
              <th>数量</th><th>要求完成日期</th><th>回模时间</th><th>备注</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    function renderSpray(o) {
      const items = o.items || [];
      let rows = items.map(it => `
        <tr>
          <td>${v(it.client_name)}</td>
          <td>${v(it.product_name)}</td>
          <td>${v(it.sample_qty)}</td>
          <td>${v(it.provide_time)}</td>
          <td>${v(it.receive_time)}</td>
          <td>${v(it.eng_complete_time)}</td>
          <td style="color:#c00;font-weight:bold">${v(it.delivery_time)}</td>
          <td>${v(it.engineer)}</td>
          <td>${v(it.notes)}</td>
        </tr>`).join('');

      return `
        <div class="print-header">
          <div class="company-name">东莞华登塑胶制品有限公司</div>
          <div class="doc-title">喷油样板表</div>
        </div>
        <div class="meta-row">
          <div class="meta-cell"><span class="meta-label">订单编号：</span><span class="meta-val">${v(o.order_number)}</span></div>
          <div class="meta-cell"><span class="meta-label">日期：</span><span class="meta-val">${v(o.date)}</span></div>
          <div class="meta-cell"><span class="meta-label">原因：</span><span class="meta-val">${v(o.reason)}</span></div>
        </div>
        <table class="print-table">
          <thead>
            <tr>
              <th>客名</th><th>名称</th><th>样板数量</th>
              <th>提供胶件时间</th><th>收到胶件时间</th><th>工程预计完成时间</th>
              <th style="color:#c00">喷油交货时间</th><th>工程师/PMC</th><th>备注</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>`;
    }
  </script>
</body>
</html>
