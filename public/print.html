<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>打印单据</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
  <style>
    body { font-family: 'Microsoft YaHei', '微软雅黑', sans-serif; background: #fff; }
    .print-wrapper { max-width: 1100px; margin: 0 auto; padding: 20px; }
    .print-header { text-align: center; margin-bottom: 10px; }
    .print-header .company-name { font-size: 22pt; font-weight: bold; }
    .print-header .doc-title { font-size: 14pt; margin: 4px 0; }
    .meta-row { display: flex; gap: 0; border: 1px solid #333; border-bottom: none; }
    .meta-cell { flex: 1; padding: 4px 8px; border-right: 1px solid #333; font-size: 10pt; }
    .meta-cell:last-child { border-right: none; }
    .meta-label { color: #333; font-weight: bold; display: inline; }
    .meta-val { border-bottom: 1px solid #333; display: inline-block; min-width: 80px; margin-left: 4px; }
    .reason-row { border: 1px solid #333; border-bottom: none; padding: 4px 8px; font-size: 10pt; }
    .print-table { width: 100%; border-collapse: collapse; font-size: 9pt; margin-top: 0; }
    .print-table th, .print-table td { border: 1px solid #333; padding: 3px 5px; text-align: center; vertical-align: middle; }
    .print-table th { background: #e8e8e8; font-weight: bold; white-space: nowrap; }
    .print-table .notes-col { background: #ffff99; font-weight: bold; }
    .checkbox-row { display: flex; gap: 0; border: 1px solid #333; border-bottom: none; font-size: 9pt; }
    .checkbox-group { flex: 1; padding: 3px 8px; border-right: 1px solid #333; }
    .checkbox-group:last-child { border-right: none; }
    .checkbox-label { font-weight: bold; margin-right: 8px; }
    .cb-item { margin-right: 10px; display: inline-block; }
    .cb-box { display: inline-block; width: 12px; height: 12px; border: 1px solid #333; margin-right: 3px; vertical-align: middle; text-align: center; line-height: 12px; font-size: 9pt; }
    .checked { background: #000; color: #fff; }
    .print-controls { position: fixed; top: 10px; right: 10px; z-index: 999; }
    @media print { .print-controls { display: none; } }

    /* Slush-specific */
    .product-img { max-width: 60px; max-height: 60px; }
  </style>
</head>
<body>
  <div class="print-controls no-print">
    <button onclick="window.print()" class="btn btn-primary btn-sm me-2">
      <i class="bi bi-printer me-1"></i>打印
    </button>
    <button onclick="window.close()" class="btn btn-secondary btn-sm">关闭</button>
  </div>

  <div class="print-wrapper" id="printContent">
    <div class="text-center py-5 text-muted" id="loading">正在加载数据...</div>
  </div>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script>
    const params = new URLSearchParams(location.search);
    const type = params.get('type');
    const id   = params.get('id');

    const typeMap = { injection: '啤办单', slush: '搪胶单', spray: '喷油单' };

    fetch(`/api/${type}/${id}`)
      .then(r => r.json())
      .then(order => {
        document.title = `${typeMap[type]} - ${order.order_number || order.id}`;
        const el = document.getElementById('printContent');
        el.innerHTML = type === 'injection' ? renderInjection(order)
                     : type === 'slush'     ? renderSlush(order)
                     :                        renderSpray(order);
        setTimeout(() => window.print(), 600);
      })
      .catch(() => {
        document.getElementById('loading').textContent = '加载失败，请关闭后重试';
      });

    function ck(checked) {
      return `<span class="cb-box${checked ? ' checked' : ''}">${checked ? '√' : ''}</span>`;
    }
    function v(val) { return val || ''; }

    function renderInjection(o) {
      const items = o.items || [];
      const isT = (t) => o.order_type === t;
      let rows = items.map(it => `
        <tr>
          <td>${v(it.seq_no)}</td>
          <td>${v(it.product_id)}</td>
          <td>${v(it.mold_id)}</td>
          <td>${v(it.mold_name)}</td>
          <td>${v(it.material)}</td>
          <td>${v(it.color)}</td>
          <td>${v(it.pigment_no)}</td>
          <td>${v(it.quantity)}</td>
          <td>${v(it.unit_weight)}</td>
          <td>${v(it.return_time)}</td>
          <td>${v(it.required_date)}</td>
          <td class="notes-col">${v(it.notes)}</td>
        </tr>`).join('');

      return `
        <div class="print-header">
          <div class="company-name">东莞华登塑胶制品有限公司</div>
          <div class="doc-title">试模/啤办通知书</div>
        </div>
        <div class="meta-row">
          <div class="meta-cell"><span class="meta-label">由：</span><span class="meta-val">工程部</span></div>
          <div class="meta-cell"><span class="meta-label">订单编号：</span><span class="meta-val">${v(o.order_number)}</span></div>
          <div class="meta-cell"><span class="meta-label">日期：</span><span class="meta-val">${v(o.date)}</span></div>
        </div>
        <div class="checkbox-row">
          <div class="checkbox-group">
            <span class="checkbox-label">EP</span>
            <span class="cb-item">${ck(false)}试模</span>
            <span class="cb-item">${ck(false)}试色</span>
            <span class="cb-item">${ck(false)}啤板</span>
          </div>
          <div class="checkbox-group">
            <span class="checkbox-label">FEP</span>
            <span class="cb-item">${ck(false)}试模</span>
            <span class="cb-item">${ck(false)}试色</span>
            <span class="cb-item">${ck(false)}啤板</span>
          </div>
          <div class="checkbox-group">
            <span class="checkbox-label">PP</span>
            <span class="cb-item">${ck(isT('试模'))}试模</span>
            <span class="cb-item">${ck(isT('试色'))}试色</span>
            <span class="cb-item">${ck(isT('啤板'))}啤板</span>
          </div>
          <div class="checkbox-group">
            <span class="checkbox-label">其他</span>
            <span class="cb-item">${ck(isT('啤办'))}初次试模</span>
          </div>
        </div>
        <div class="reason-row"><strong>原因：</strong>${v(o.reason)}</div>
        <table class="print-table">
          <thead>
            <tr>
              <th>序号</th><th>产品编号</th><th>工模编号</th><th>工模名称</th>
              <th>原料</th><th>颜色</th><th>色粉编号</th><th>数量(啤)</th>
              <th>整啤重量(g)</th><th>回模时间</th><th>要求日期</th><th>备注</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    function renderSlush(o) {
      const items = o.items || [];
      let rows = items.map(it => `
        <tr>
          <td>${v(it.seq_no)}</td>
          <td>${v(it.product_id)}</td>
          <td>${it.product_image ? `<img src="${it.product_image}" class="product-img">` : ''}</td>
          <td>${v(it.mold_id)}</td>
          <td>${v(it.mold_name)}</td>
          <td>${v(it.material)}</td>
          <td>${v(it.color_code)}</td>
          <td>${v(it.pigment_no)}</td>
          <td>${v(it.unit_weight)}</td>
          <td>${v(it.quantity)}</td>
          <td>${v(it.required_date)}</td>
          <td>${v(it.return_time)}</td>
          <td>${v(it.notes)}</td>
        </tr>`).join('');

      return `
        <div class="print-header">
          <div class="company-name">东莞兴信塑胶制品有限公司</div>
          <div class="doc-title">搪胶搪办通知书</div>
        </div>
        <div class="meta-row">
          <div class="meta-cell"><span class="meta-label">由：</span><span class="meta-val">工程部</span></div>
          <div class="meta-cell"><span class="meta-label">订单编号：</span><span class="meta-val">${v(o.order_number)}</span></div>
          <div class="meta-cell"><span class="meta-label">日期：</span><span class="meta-val">${v(o.date)}</span></div>
          <div class="meta-cell"><span class="meta-label">车间：</span><span class="meta-val">搪胶部</span></div>
        </div>
        <div class="checkbox-row">
          <div class="checkbox-group">
            <span class="checkbox-label">EP</span>
            <span class="cb-item">${ck(false)}试模</span>
            <span class="cb-item">${ck(false)}试色</span>
            <span class="cb-item">${ck(false)}啤板</span>
          </div>
          <div class="checkbox-group">
            <span class="checkbox-label">FEP</span>
            <span class="cb-item">${ck(false)}试模</span>
            <span class="cb-item">${ck(false)}试色</span>
            <span class="cb-item">${ck(false)}啤板</span>
          </div>
          <div class="checkbox-group">
            <span class="checkbox-label">PP</span>
            <span class="cb-item">${ck(false)}试模</span>
            <span class="cb-item">${ck(false)}试色</span>
            <span class="cb-item">${ck(o.order_type==='搪办')}啤板</span>
          </div>
          <div class="checkbox-group">
            <span class="checkbox-label">其他</span>
            <span class="cb-item">${ck(true)}新颜色啤办</span>
          </div>
        </div>
        <div class="reason-row"><strong>原因：</strong>${v(o.reason)}</div>
        <table class="print-table">
          <thead>
            <tr>
              <th>序号</th><th>产品编号</th><th>产品图片</th><th>工模编号</th><th>工模名称</th>
              <th>原料</th><th>颜色/编号</th><th>色粉编号</th><th>每啤毛重</th>
              <th>数量</th><th>要求完成日期</th><th>回模时间</th><th>备注</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    function renderSpray(o) {
      const items = o.items || [];
      let rows = items.map(it => `
        <tr>
          <td>${v(it.client_name)}</td>
          <td>${v(it.product_name)}</td>
          <td>${v(it.sample_qty)}</td>
          <td>${v(it.provide_time)}</td>
          <td>${v(it.receive_time)}</td>
          <td>${v(it.eng_complete_time)}</td>
          <td style="color:#c00;font-weight:bold">${v(it.delivery_time)}</td>
          <td>${v(it.engineer)}</td>
          <td>${v(it.notes)}</td>
        </tr>`).join('');

      return `
        <div class="print-header">
          <div class="company-name">东莞华登塑胶制品有限公司</div>
          <div class="doc-title">喷油样板表</div>
        </div>
        <div class="meta-row">
          <div class="meta-cell"><span class="meta-label">订单编号：</span><span class="meta-val">${v(o.order_number)}</span></div>
          <div class="meta-cell"><span class="meta-label">日期：</span><span class="meta-val">${v(o.date)}</span></div>
          <div class="meta-cell"><span class="meta-label">原因：</span><span class="meta-val">${v(o.reason)}</span></div>
        </div>
        <table class="print-table">
          <thead>
            <tr>
              <th>客名</th><th>名称</th><th>样板数量</th>
              <th>提供胶件时间</th><th>收到胶件时间</th><th>工程预计完成时间</th>
              <th style="color:#c00">喷油交货时间</th><th>工程师/PMC</th><th>备注</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>`;
    }
  </script>
</body>
</html>
